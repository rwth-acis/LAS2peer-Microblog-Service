// Generated by CoffeeScript 1.7.1
(function() {
  var addBlogInput, api, commitBlogInput, fetchEntries, initEvents, initMicroblogSelector, isEnteringInput, iwcCallback, iwcManager, login, microblogLib, requestSender;

  api = i5.las2peer.jsAPI;

  microblogLib = i5.las2peer.microblog;


  /*
    Check explicitly if gadgets is known, i.e. script is executed in widget environment.
    Allows compatibility as a Web page.
   */

  if (typeof gadgets !== "undefined" && gadgets !== null) {
    iwcCallback = function(intent) {};
    iwcManager = new api.IWCManager(iwcCallback);
  }

  login = new api.Login(api.LoginTypes.HTTP_BASIC);

  login.setUserAndPassword(clientDefaults.userName, clientDefaults.userPassword);


  /*
    Init RequestSender object with uri and login data.
   */

  requestSender = new api.RequestSender(clientDefaults.address, login);

  isEnteringInput = false;

  $(document).ready(function() {
    return initMicroblogSelector();
  });

  initMicroblogSelector = function() {
    initEvents();
    return fetchEntries();
  };

  initEvents = function() {
    return $("#addEntry").click(function() {
      return addBlogInput();
    });
  };


  /*
    Inserts input field to create a new microblog.
   */

  addBlogInput = function() {
    var textfieldDiv;
    if (isEnteringInput) {
      return 0;
    }
    textfieldDiv = document.createElement("div");
    textfieldDiv.id = "textfieldBox";
    textfieldDiv.className = "selectItem";
    $(textfieldDiv).html('<label>Blog Name: </label>' + '<input type="text" name="blogName" id="enterBlogName" value="" >');
    $("#content").append(textfieldDiv);

    /*
      Accept on ENTER
     */
    $("#enterBlogName").keypress(function(e) {
      if (e.which === 13) {
        commitBlogInput();
        return false;
      }
    });
    isEnteringInput = true;
    return $("#enterBlogName").focus();
  };


  /*
    Remove input field and notify service.
    Fetch blog entries after that (update microblog list).
   */

  commitBlogInput = function() {
    var id, name;
    name = $("#enterBlogName").val().trim();
    isEnteringInput = false;
    $("#textfieldBox").remove();
    id = microblogLib.Encoder.formatAsId(name);
    if (id.length > 0) {
      return requestSender.sendRequest("put", "blogs/" + id + "?name=" + name, "", function() {
        return fetchEntries();
      });
    }
  };


  /*
    Get all available microblogs from the service
   */

  fetchEntries = function() {
    $("#content").html("");
    return requestSender.sendRequest("get", "blogs", "", function(data) {
      var $xml, xml;
      xml = $.parseXML(data);
      $xml = $(xml);
      return $xml.find("child").each(function(index) {
        var div;
        div = document.createElement("div");
        div.className = "selectItem";
        div.id = $(this).attr("id");
        $(div).text($(this).attr("name"));
        $(div).append("<span style='font-size:small;' id=" + div.id + ">" + " by " + microblogLib.Encoder.escapeUnsafe($(this).attr("owner")) + "</span>");

        /*
          Send intent if a microblog is selected, so other widgets can update their contents.
         */
        $(div).click(function(event) {
          if (typeof gadgets !== "undefined" && gadgets !== null) {
            return iwcManager.sendIntent("MICROBLOG_SELECTED", event.target.id);
          }
        });
        return $("#content").append(div);
      });
    }, function(error) {
      return alert(error);
    });
  };

}).call(this);

//# sourceMappingURL=microblog-selector.js.map